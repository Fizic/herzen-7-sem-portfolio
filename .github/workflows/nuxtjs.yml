name: Deploy Nuxt site to Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
          elif [ -f "${{ github.workspace }}/package.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
          else
            echo "Unable to determine package manager"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      - name: Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

      # Установка base URL для GitHub Pages
      - name: Create nuxt.config.js with base URL
        run: |
          if [ -f "nuxt.config.js" ]; then
            # Создаем резервную копию
            cp nuxt.config.js nuxt.config.js.backup

            # Если нужно, добавьте конфигурацию для GitHub Pages
            # Это альтернативный вариант, если не хотите менять исходный файл
            echo "Создание конфигурации для GitHub Pages..."

            # Создаем отдельный конфиг для продакшена
            cat > nuxt.config.gh-pages.js << 'EOF'
            import originalConfig from './nuxt.config.js'

            export default {
              ...originalConfig,
              app: {
                ...originalConfig.app,
                baseURL: '/herzen-7-sem-portfolio/',
                buildAssetsDir: '/_nuxt/',
                cdnURL: 'https://fizic.github.io/herzen-7-sem-portfolio/'
              },
              ssr: false,
              target: 'static',
              router: {
                base: '/herzen-7-sem-portfolio/'
              }
            }
            EOF

          else
            # Если файл конфигурации не найден, создаем простой
            echo "Создание базового nuxt.config.js..."
            cat > nuxt.config.js << 'EOF'
            export default {
              app: {
                baseURL: '/herzen-7-sem-portfolio/',
                buildAssetsDir: '/_nuxt/'
              },
              ssr: false,
              target: 'static',
              router: {
                base: '/herzen-7-sem-portfolio/'
              },
              generate: {
                dir: 'dist'
              }
            }
            EOF
          fi

      - name: Build with Nuxt
        run: |
          if [ -f "nuxt.config.gh-pages.js" ]; then
            # Используем специальную конфигурацию для GitHub Pages
            ${{ steps.detect-package-manager.outputs.manager }} run generate --config-file nuxt.config.gh-pages.js
          else
            ${{ steps.detect-package-manager.outputs.manager }} run generate
          fi

      # Для GitHub Pages нужно переместить файлы в корень dist
      - name: Prepare for GitHub Pages
        run: |
          if [ -d "dist" ]; then
            # Создаем .nojekyll файл для отключения Jekyll обработки
            touch dist/.nojekyll

            # Если Nuxt создал папку с именем репозитория внутри dist
            if [ -d "dist/herzen-7-sem-portfolio" ]; then
              echo "Moving files from subdirectory to root..."
              mv dist/herzen-7-sem-portfolio/* dist/
              rm -rf dist/herzen-7-sem-portfolio
            fi

            # Проверяем содержимое dist
            echo "Contents of dist directory:"
            ls -la dist/
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
